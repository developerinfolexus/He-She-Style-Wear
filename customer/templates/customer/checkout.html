{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - HE SHE STYLE WEAR</title>
    <link rel="icon" href="{% static 'customer/images/logo.png' %}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link rel="stylesheet" href="{% static 'customer/css/index.css' %}">
    <link rel="stylesheet" href="{% static 'customer/css/checkout.css' %}">
    <style>
        /* Ensure hidden class is available if not in CSS files */
        .hidden {
            display: none !important;
        }

        /* Keep header max-width consistent if needed */
        #header-placeholder .main-header {
            max-width: 1500px;
            margin: 0 auto;
        }
    </style>
</head>

<body data-header-url="{% url 'api_header' %}">

    <div id="header-placeholder"></div>

    <main class="checkout-page-container container">
        <h1>Checkout</h1>


        <div class="checkout-progress" id="checkout-progress-bar">
            <div class="step active" data-step="cart">
                <div class="step-indicator"></div>
                <span>Cart</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="billing">
                <div class="step-indicator"></div>
                <span>Billing & address</span>
            </div>
            <div class="step-line"></div>
            <div class="step" data-step="payment">
                <div class="step-indicator"></div>
                <span>Payment</span>
            </div>
        </div>

        <div class="checkout-layout">

            <div class="checkout-steps-container">

                <section class="cart-details-section checkout-step-section" id="cart-step">
                    <h2 id="cart-section-title">Cart (0 items)</h2>
                    <div class="cart-items-table">
                        <div class="cart-table-header">
                            <div class="col-product">Product</div>
                            <div class="col-price">Price</div>
                            <div class="col-quantity">Quantity</div>
                            <div class="col-total">Total price</div>
                            <div class="col-remove"></div>
                        </div>
                        <div id="cart-items-container">
                            <p class="empty-cart-message">Your cart is empty.</p>
                        </div>
                    </div>
                    <a href="{% url 'index' %}" class="continue-shopping-link">
                        <i class="fas fa-arrow-left"></i> Continue shopping
                    </a>
                </section>


                <section class="billing-address-section checkout-step-section hidden" id="billing-step">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                        <h2>Billing & address</h2>
                        {% if saved_address and saved_address.address %}
                        <div class="address-actions" style="display:flex; gap:10px;">
                            <button type="button" id="change-address-btn"
                                style="background:none; border:none; color:#007bff; cursor:pointer; font-weight:600; text-decoration:underline;">Change
                                Address</button>
                            <button type="button" id="save-address-btn"
                                style="background:none; border:none; color:#28a745; cursor:pointer; font-weight:600; text-decoration:underline; display:none;">Save
                                Address</button>
                        </div>
                        {% endif %}
                    </div>
                    <form id="billing-address-form" novalidate>
                        <div class="form-group">
                            <label for="billing-email">Email</label>
                            <input type="email" id="billing-email" name="billing-email" placeholder="Enter your email"
                                value="{% if saved_address.email %}{{ saved_address.email }}{% elif user.is_authenticated %}{{ user.email }}{% endif %}"
                                required {% if saved_address and saved_address.address %} readonly {% endif %}>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="billing-first-name">First Name</label>
                                <input type="text" id="billing-first-name" name="billing-first-name"
                                    placeholder="First Name"
                                    value="{% if saved_address.first_name %}{{ saved_address.first_name }}{% elif user.is_authenticated %}{{ user.first_name }}{% endif %}"
                                    required {% if saved_address and saved_address.address %} readonly {% endif %}>
                            </div>
                            <div class="form-group">
                                <label for="billing-last-name">Last Name</label>
                                <input type="text" id="billing-last-name" name="billing-last-name"
                                    placeholder="Last Name"
                                    value="{% if saved_address.last_name %}{{ saved_address.last_name }}{% elif user.is_authenticated %}{{ user.last_name }}{% endif %}"
                                    required {% if saved_address and saved_address.address %} readonly {% endif %}>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="billing-address">Address</label>
                            <input type="text" id="billing-address" name="billing-address" placeholder="Street address"
                                value="{{ saved_address.address|default:'' }}" required {% if saved_address and saved_address.address %} readonly {% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="billing-apartment" class="visually-hidden">Apartment, suite, etc.
                                (optional)</label>
                            <input type="text" id="billing-apartment" name="billing-apartment"
                                placeholder="Apartment, suite, etc. (optional)" {% if saved_address and saved_address.address %} readonly {% endif %}>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="billing-city">City</label>
                                <input type="text" id="billing-city" name="billing-city" placeholder="City"
                                    value="{{ saved_address.city|default:'' }}" required {% if saved_address and saved_address.address %} readonly {% endif %}>
                            </div>
                            <div class="form-group">
                                <label for="billing-state" id="billing-state-label">State / Province</label>
                                <input type="text" id="billing-state" name="billing-state"
                                    placeholder="State / Province" required value="{{ saved_address.state|default:'' }}"
                                    {% if saved_address and saved_address.address %} readonly {% endif %}>
                            </div>
                            <div class="form-group">
                                <label for="billing-postal" id="billing-postal-label">Postal Code</label>
                                <input type="text" id="billing-postal" name="billing-postal" placeholder="Postal Code"
                                    required maxlength="10"
                                    pattern="^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$|^\d{5}(-\d{4})?$"
                                    title="Enter a valid Canadian (A1A 1A1) or US (12345 or 12345-6789) postal/zip code"
                                    value="{{ saved_address.pincode|default:'' }}" {% if saved_address and saved_address.address %} readonly {% endif %}>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="billing-country">Country</label>
                            <select id="billing-country" name="billing-country" required {% if saved_address and saved_address.address %} disabled {% endif %}>
                                <option value="CA" {% if saved_address.country == 'CA' %}selected{% endif %}>Canada
                                </option>
                                <option value="US" {% if saved_address.country == 'US' %}selected{% endif %}>United States
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="billing-phone">Phone</label>
                            <input type="tel" id="billing-phone" name="billing-phone" placeholder="Phone number" required
                                inputmode="numeric" value="{{ saved_address.phone|default:'' }}" {% if saved_address and saved_address.address %} readonly {% endif %}>
                        </div>

                        <div class="billing-actions">
                            <button type="button" class="back-button" id="back-to-cart-btn"><i
                                    class="fas fa-arrow-left"></i> Back to Cart</button>
                            <button type="submit" class="proceed-button" id="proceed-to-payment-btn">Proceed to
                                Payment</button>
                        </div>
                    </form>
                </section>


                <section class="payment-section checkout-step-section hidden" id="payment-step">

                    <h2>Delivery</h2>
                    <div class="delivery-options-container">
                        <div>
                            <input type="radio" name="delivery-method" id="delivery-standard" value="standard"
                                class="delivery-radio" data-cost="10" checked>
                            <label for="delivery-standard" class="delivery-option-card">
                                <i class="fas fa-truck delivery-option-icon"></i>
                                <div class="delivery-option-text">
                                    <strong>Standard</strong>
                                    <p>3-5 days delivery</p>
                                </div>
                                <span class="delivery-option-price">$10</span>
                            </label>
                        </div>
                        <div style="display:none;">
                            <input type="radio" name="delivery-method" id="delivery-express" value="express"
                                class="delivery-radio" data-cost="15">
                            <label for="delivery-express" class="delivery-option-card">
                                <i class="fas fa-shipping-fast delivery-option-icon"></i>
                                <div class="delivery-option-text">
                                    <strong>Express</strong>
                                    <p>2-3 days delivery</p>
                                </div>
                                <span class="delivery-option-price">$15</span>
                            </label>
                        </div>
                    </div>
                    <h2>Payment</h2>
                    <div class="payment-options-container">

                        <div>
                            <input type="radio" name="payment-method" id="pay-paypal" value="paypal"
                                class="payment-radio" checked>
                            <label for="pay-paypal" class="payment-option-card">
                                <div class="payment-option-text">
                                    <strong>Pay with Paypal</strong>
                                    <p>You will be redirected to PayPal website to complete your purchase securely.</p>
                                </div>
                                <div class="payment-logos">
                                    <i class="fab fa-paypal"></i>
                                </div>
                            </label>
                        </div>


                        <div>
                            <input type="radio" name="payment-method" id="pay-card" value="card" class="payment-radio">
                            <label for="pay-card" class="payment-option-card">
                                <div class="payment-option-text">
                                    <strong>Interac/ Credit / Debit card</strong>
                                    <p>We support Interac, Mastercard, Visa.</p>
                                </div>
                                <div class="payment-logos">
                                    <img src="https://th.bing.com/th/id/OIP.JmMFmNGdbKltQCFvGo_pxQHaDs?w=332&h=174&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3"
                                        alt="Interac Logo" class="interac-logo">
                                    <i class="fab fa-cc-visa"></i>
                                    <i class="fab fa-cc-mastercard"></i>
                                </div>
                            </label>


                            <div class="payment-details-form" id="card-details-form">
                                <div class="form-group">
                                    <label for="card-name">Name on card</label>
                                    <input type="text" id="card-name" placeholder="John M. Doe">
                                </div>
                                <div class="form-group">
                                    <label for="card-number">Card number</label>
                                    <input type="text" id="card-number" placeholder="1234-5678-9012-3456"
                                        inputmode="numeric">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="card-expiry">Expiry</label>
                                        <input type="text" id="card-expiry" placeholder="MM / YY">
                                    </div>
                                    <div class="form-group">
                                        <label for="card-cvc">CVC</label>
                                        <input type="text" id="card-cvc" placeholder="123" inputmode="numeric">
                                    </div>
                                </div>
                            </div>


                        </div>

                        <!-- <div>
                            <input type="radio" name="payment-method" id="pay-cash" value="cash" class="payment-radio">
                            <label for="pay-cash" class="payment-option-card">
                                <div class="payment-option-text">
                                    <strong>Cash</strong>
                                    <p>Pay with cash when your order is delivered.</p>
                                </div>
                                <div class="payment-logos">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </label>
                        </div> -->

                    </div>

                    <div class="billing-actions">
                        <button type="button" class="back-button" id="back-to-billing-btn"><i
                                class="fas fa-arrow-left"></i> Back to Billing</button>
                        <button type="button" class="proceed-button" id="confirm-payment-btn">Confirm Payment</button>
                    </div>
                </section>

            </div>

            <aside class="order-summary-section">
                <h2>Order summary</h2>
                <div class="summary-details">
                    <div class="summary-row">
                        <span>Item</span>
                        <span id="summary-subtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping</span>
                        <span id="summary-shipping">Free</span>
                    </div>
                    <div class="summary-row">
                        <span>GST (5%)</span>
                        <span id="summary-gst">$0.00</span>
                    </div>
                    <div class="summary-row" id="coupon-discount-row" style="display: none; color: #0a6;">
                        <span>Coupon Discount</span>
                        <span id="summary-discount">- $0.00</span>
                    </div>

                    <div class="summary-total-row">
                        <span>Order</span>
                        <span id="summary-total">$0.00</span>
                    </div>
                    <!-- <p class="vat-note">(VAT included if applicable)</p> -->
                </div>
                <div class="discount-section">
                    <div id="available-coupons" class="available-coupons"
                        style="margin-bottom:15px;font-size:0.95rem;color:#111;width:100%;">
                        <!-- populated by checkout.js: lists available coupon codes for cart subcategories -->
                    </div>
                </div>
                <div class="discount-wrapper">

                    <div class="discount-input-group">
                        <label for="discount-code" class="visually-hidden">Discount Code</label>
                        <input type="text" id="discount-code" placeholder="Enter Discount Code">
                        <button type="button" id="apply-discount-btn">Apply</button>
                    </div>

                    <button type="button" class="checkout-button" id="main-checkout-action-btn">Check out</button>
                </div>
            </aside>

        </div>
    </main>


    <div class="whatsapp-container">
        <div class="whatsapp-tooltip">Need More Information</div>
        <a href="https://wa.me/17808864821" class="whatsapp-float" target="_blank" aria-label="Chat on WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>
    {% include 'customer/footer.html' %}


    <div id="reviews-modal-overlay" class="reviews-modal-overlay">
        <div class="reviews-modal">
            <div class="reviews-modal-header">
                <h2>Customer Reviews</h2><button id="close-reviews-modal" class="close-reviews-modal">&times;</button>
            </div>
            <div class="reviews-modal-body">
                <div class="reviews-grid"></div>
            </div>
        </div>
    </div>



    <script src="{% static 'customer/js/index.js' %}"></script>
    <script src="{% static 'customer/js/checkout.js' %}?v=9"></script>


    <script>
        const headerUrl = document.body.dataset.headerUrl || '/api/header/';
        fetch(headerUrl)
            .then(response => response.ok ? response.text() : Promise.reject('Failed to load header'))
            .then(data => {
                const headerPlaceholder = document.getElementById('header-placeholder');
                if (headerPlaceholder) {
                    headerPlaceholder.innerHTML = data;
                    // Re-initialize dynamic header parts from index.js
                    if (typeof setupSearchFunctionality === 'function') setupSearchFunctionality();
                    if (typeof setupProfileDropdown === 'function') setupProfileDropdown();
                    if (typeof setupNavDropdowns === 'function') setupNavDropdowns();
                    if (typeof setupRegionFlagDropdown === 'function') setupRegionFlagDropdown();

                    // --- THIS IS THE FIX ---
                    // This line was missing, so the mobile menu click events were not being attached
                    if (typeof setupMobileMenuToggle === 'function') setupMobileMenuToggle();
                    // --- END FIX ---

                    // Call count updates AFTER header is loaded
                    if (typeof updateCartCount === 'function') updateCartCount();
                    if (typeof updateWishlistCount === 'function') updateWishlistCount();


                    // Remove active nav link
                    headerPlaceholder.querySelectorAll(".main-nav li.active")
                        .forEach(link => link.classList.remove('active'));
                }
            })
            .catch(error => console.error('Error loading header:', error));
    </script>

    <script>
        window.isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const phoneInput = document.getElementById('billing-phone');
            if (phoneInput) {
                // This event listener strips out any non-digit characters
                phoneInput.addEventListener('input', function (e) {
                    this.value = this.value.replace(/\D/g, '');
                });
            }
        });
    </script>
    <style>
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var changeBtn = document.getElementById('change-address-btn');
            var saveBtn = document.getElementById('save-address-btn');
            var form = document.getElementById('billing-address-form');
            var countrySelect = document.getElementById('billing-country');

            // --- Change Address Logic ---
            if (changeBtn) {
                changeBtn.addEventListener('click', function () {
                    if (!form) return;

                    // Enable all inputs
                    var inputs = form.querySelectorAll('input');
                    inputs.forEach(function (input) {
                        input.removeAttribute('readonly');
                    });

                    // Enable selects (especially Country)
                    var selects = form.querySelectorAll('select');
                    selects.forEach(function (select) {
                        select.removeAttribute('disabled');
                    });

                    // Hide Change, Show Save
                    this.style.display = 'none';
                    if (saveBtn) saveBtn.style.display = 'inline-block';

                    // Focus on first input
                    var firstInput = form.querySelector('input:not([type="hidden"])');
                    if (firstInput) firstInput.focus();
                });
            }

            // --- Save Address Logic (Client-Side Only) ---
            if (saveBtn) {
                saveBtn.addEventListener('click', function () {
                    if (!form) return;

                    // Validate form
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }

                    // Disable inputs (make readonly)
                    var inputs = form.querySelectorAll('input');
                    inputs.forEach(function (input) {
                        input.setAttribute('readonly', true);
                    });

                    // Disable selects
                    var selects = form.querySelectorAll('select');
                    selects.forEach(function (select) {
                        select.setAttribute('disabled', true);
                    });

                    // Hide Save, Show Change
                    this.style.display = 'none';
                    if (changeBtn) changeBtn.style.display = 'inline-block';
                });
            }

            // --- Fix for Country Dropdown / Region Logic ---
            // Ensure that when we are in "Change" mode (dropdown enabled), 
            // external logic (like region selector) triggers correctly update the dropdown if needed,
            // BUT we must allow the user to manually change it too.
            // The key issue "dropdown works only the first time" implies state wasn't resetting correctl or 
            // logic in checkout.js was guarding it.
            // By properly removing 'disabled' attribute, it should work. 
            // We also need to ensure that when we click "Save" and disable it, the value is preserved.

            // Important: checkout.js reads countrySelect.value. If it's disabled, .value property is still valid in DOM.
        });
    </script>
</body>

</html>